const SVG_NS="http://www.w3.org/2000/svg";
let svgWrap,tooltip;
function normalizeId(s){if(!s)return'';try{s=s.normalize('NFKC')}catch(e){}return String(s).trim()}
function normalizeName(n){if(!n)return'';let s=String(n);try{s=s.normalize('NFKC')}catch(e){}s=s.replace(/\uff08.*?\uff09/g,'');s=s.replace(/\(.*?\)/g,'');s=s.replace(/\u3000/g,'');s=s.replace(/\s+/g,'');s=s.replace(/・/g,'');return s.trim().toLowerCase()}
function digitsOnly(s){if(!s)return'';const m=String(s).normalize('NFKC').match(/(\d{1,6})/);return m?m[1].replace(/^0+/,'')||'0':''}
const EW_STATIONS=["伊野","伊野駅前","鳴谷","北山","北内","伊野商業前","枝川","中山","八代通","宇治団地前","咥内","宮の奥","朝倉神社前","朝倉駅前","朝倉","曙町","曙町東町","鴨部","鏡川橋","蛍橋","旭町三丁目","旭駅前通","旭町一丁目","上町五丁目","上町四丁目","上町二丁目","上町一丁目","枡形","グランド通","県庁前","高知城前","大橋通","堀詰","はりまや橋","デンテツ・ターミナルビル前","菜園場町","宝永町","知寄町一丁目","知寄町二丁目","知寄町","知寄町三丁目","葛島橋東詰","西高須","県立美術館通","高須","文珠通","介良通","新木","東新木","田辺島通","鹿児","舟戸","北浦","領石通","清和学園前","一条橋","明見橋","長崎","小篭通","篠原","住吉通","東工業前","後免西町","後免中町","後免東町","後免町"];
const SN_STATIONS=["高知駅前","高知橋","蓮池町通","はりまや橋","梅の辻","桟橋通一丁目","桟橋通二丁目","桟橋通三丁目","桟橋通四丁目","桟橋車庫前","桟橋通五丁目"];
function displayStationName(n){if(!n)return n;if(/デンテツ.*ターミナル.*ビル/i.test(n))return'デンタミ';if(/後免西町/i.test(n))return'ごめん西町';if(/後免中町/i.test(n))return'ごめん中町';if(/後免東町/i.test(n))return'ごめん東町';if(/後免町/i.test(n))return'ごめん町';if(/菜園場町|菜園前/i.test(n))return'菜園場町';return n}
const getColumns=()=>window.innerWidth<=768?10:5;
let per=Math.ceil(EW_STATIONS.length/getColumns());
function buildROWS_STATIONS(){const cols=getColumns();per=Math.ceil(EW_STATIONS.length/cols);const rows=[];for(let i=0;i<cols;i++){const start=i*per;const end=Math.min((i+1)*per,EW_STATIONS.length);if(start<EW_STATIONS.length){rows.push(EW_STATIONS.slice(start,end))}}const snCols=window.innerWidth<=768?2:1;const snPer=Math.ceil(SN_STATIONS.length/snCols);for(let i=0;i<snCols;i++){const start=i*snPer;const end=Math.min((i+1)*snPer,SN_STATIONS.length);if(start<SN_STATIONS.length){rows.push(SN_STATIONS.slice(start,end))}}return rows}
let ROWS_STATIONS=buildROWS_STATIONS();
const ROWS=ROWS_STATIONS.length;
let viewW=1400,viewH=800;
const marginLeft=window.innerWidth<=768?10:100,marginRight=window.innerWidth<=768?10:80,marginTop=window.innerWidth<=768?5:40,marginBottom=window.innerWidth<=768?5:48;
let rowY=[],stationPos=[];
function buildSVG(){viewW=svgWrap.offsetWidth;viewH=svgWrap.offsetHeight;const rowHeight=viewH/ROWS;rowY=[];stationPos=[];for(let r=0;r<ROWS;r++){const yCenter=marginTop+r*rowHeight+rowHeight/2;rowY.push(yCenter);const stations=ROWS_STATIONS[r];const n=stations.length;const xStart=marginLeft;const xEnd=viewW-marginRight;const xStep=(xEnd-xStart)/(n-1);const pos=[];for(let i=0;i<n;i++){pos.push(xStart+i*xStep)}stationPos.push(pos)}let svg=svgWrap.querySelector('svg');if(!svg){svg=document.createElementNS(SVG_NS,'svg');svg.setAttribute('viewBox','0 0 '+viewW+' '+viewH);svg.setAttribute('preserveAspectRatio','xMidYMid meet');svgWrap.appendChild(svg)}else{svg.setAttribute('viewBox','0 0 '+viewW+' '+viewH)}svg.innerHTML='';const tracksG=document.createElementNS(SVG_NS,'g');tracksG.id='tracks';svg.appendChild(tracksG);for(let r=0;r<ROWS;r++){const pos=stationPos[r];const yCenter=rowY[r];for(let i=0;i<pos.length-1;i++){const line=document.createElementNS(SVG_NS,'line');line.setAttribute('x1',pos[i]);line.setAttribute('y1',yCenter);line.setAttribute('x2',pos[i+1]);line.setAttribute('y2',yCenter);line.setAttribute('class','track-line');tracksG.appendChild(line);const mid=(pos[i]+pos[i+1])/2;const tick=document.createElementNS(SVG_NS,'line');tick.setAttribute('x1',mid);tick.setAttribute('y1',yCenter-4);tick.setAttribute('x2',mid);tick.setAttribute('y2',yCenter+4);tick.setAttribute('class','tick');tracksG.appendChild(tick)}}const stationsG=document.createElementNS(SVG_NS,'g');stationsG.id='stations';svg.appendChild(stationsG);for(let r=0;r<ROWS;r++){const pos=stationPos[r];const yCenter=rowY[r];const stations=ROWS_STATIONS[r];for(let i=0;i<pos.length;i++){const rect=document.createElementNS(SVG_NS,'rect');const w=window.innerWidth<=768?70:60;const h=window.innerWidth<=768?32:24;rect.setAttribute('x',pos[i]-w/2);rect.setAttribute('y',yCenter-h/2);rect.setAttribute('width',w);rect.setAttribute('height',h);rect.setAttribute('class','station-rect');stationsG.appendChild(rect);const text=document.createElementNS(SVG_NS,'text');text.setAttribute('x',pos[i]);text.setAttribute('y',yCenter);text.setAttribute('class','station-text');text.textContent=displayStationName(stations[i]);stationsG.appendChild(text)}}const trainsG=document.createElementNS(SVG_NS,'g');trainsG.id='trains';svg.appendChild(trainsG)}
let currentTime=0,playRate=1,anim=null,lastTs=null,currentDayType='weekday';
function nowSeconds(){const now=new Date();return now.getHours()*3600+now.getMinutes()*60+now.getSeconds()}
let trips={},opMap={},tripRoute={},tripDayType={},tripsByOperation={},waitingTrains={};
async function loadData(){const resp=await fetch('data_with_ops.json');if(!resp.ok)throw new Error('data_with_ops.json load failed');const json=await resp.json();trips={};opMap={};tripRoute={};tripDayType={};tripsByOperation={};json.forEach(item=>{const tid=normalizeId(item.trip_id);if(!tid)return;const seq=item.stops.map(s=>({seq:s.stop_sequence,stop_name:s.stop_name,arrival:hhmmssToSec(s.arrival_time),departure:hhmmssToSec(s.departure_time)}));seq.sort((a,b)=>a.seq-b.seq);trips[tid]=seq;opMap[tid]=digitsOnly(item.operation_number||'');tripRoute[tid]=item.route_id||'UNK';tripDayType[tid]=item.day_type||'weekday';const opNum=opMap[tid];const dayType=tripDayType[tid]||'weekday';const opKey=dayType+'_'+opNum;if(!tripsByOperation[opKey])tripsByOperation[opKey]=[];const firstDeparture=seq.length>0&&seq[0].departure!=null?seq[0].departure:null;tripsByOperation[opKey].push({tid,firstDeparture});if(opNum){if(!window.opDebug[opNum])window.opDebug[opNum]=[];window.opDebug[opNum].push(tid)}});Object.keys(tripsByOperation).forEach(key=>{tripsByOperation[key].sort((a,b)=>(a.firstDeparture||0)-(b.firstDeparture||0))});currentTime=nowSeconds();console.log('Data loaded:',Object.keys(trips).length,'trips')}
async function loadUnyoIfExists(){try{const r=await fetch('unyo.json');if(!r.ok)return;const j=await r.json();if(!j||!Array.isArray(j))return;j.forEach(u=>{const tid=normalizeId(u.trip_id);if(!tid)return;const num=digitsOnly(u.operation_number||'');if(num)opMap[tid]=num})}catch(e){}}
function getOperationNumber(tid,fallback){const num=opMap[tid];return num||String(fallback)}
function getDestCharByStops(seq,tid){if(!seq||!seq.length)return'?';const last=seq[seq.length-1];const lastName=last.stop_name||'';if(/伊野駅|伊野$/i.test(lastName))return'伊';if(/後免/i.test(lastName))return'後';if(/高知駅/i.test(lastName))return'高';if(/桟橋.*五/i.test(lastName))return'桟';if(/桟橋.*四/i.test(lastName))return'四';if(/はりまや橋/i.test(lastName))return'橋';if(/朝倉/i.test(lastName))return'朝';if(/鏡川橋/i.test(lastName))return'鏡';if(/枡形/i.test(lastName))return'枡';if(/知寄町/i.test(lastName))return'知';if(/文珠通/i.test(lastName))return'文';if(/介良通/i.test(lastName))return'介';if(/領石通/i.test(lastName))return'領';return'?'}
function renderTrains(){if(!svgWrap)return;const svg=svgWrap.querySelector('svg');if(!svg)return;const g=svg.querySelector('#trains');if(!g)return;g.innerHTML='';let fallbackIndex=1;const renderedTrips=new Set();waitingTrains={};let trainCount=0;Object.keys(trips).forEach(tid=>{if(renderedTrips.has(tid))return;if(tripDayType[tid]&&tripDayType[tid]!==currentDayType)return;const seq=trips[tid];const route=tripRoute[tid]||'UNK';let trainRendered=false;const lastStop=seq[seq.length-1];const lastArrival=lastStop&&lastStop.arrival!=null?lastStop.arrival:null;if(lastArrival!=null){const opNum=opMap[tid];const dayType=tripDayType[tid]||'weekday';const opKey=dayType+'_'+opNum;const opTrips=tripsByOperation[opKey]||[];let nextTrip=null;for(let i=0;i<opTrips.length;i++){if(opTrips[i].tid===tid&&i+1<opTrips.length){nextTrip=opTrips[i+1];break}}if(currentTime>=lastArrival&&nextTrip&&currentTime<nextTrip.firstDeparture){const stationName=normalizeName(lastStop.stop_name||'');if(!waitingTrains[stationName])waitingTrains[stationName]=[];let direction='down';for(let i=seq.length-2;i>=0;i--){const a=seq[i],b=seq[i+1];const aName=normalizeName(a.stop_name||'');const bName=normalizeName(b.stop_name||'');let idxA=-1,idxB=-1;for(let r=0;r<ROWS;r++){const stations=ROWS_STATIONS[r];for(let si=0;si<stations.length;si++){const sNorm=normalizeName(stations[si]);if(sNorm===aName)idxA=si;if(sNorm===bName)idxB=si}if(idxA>=0&&idxB>=0)break}if(idxA>=0&&idxB>=0){direction=(idxB>idxA)?'down':'up';break}}direction=(direction==='up')?'down':'up';waitingTrains[stationName].push({tid,endTime:lastArrival,direction,nextDeparture:nextTrip.firstDeparture,nextTripId:nextTrip.tid});renderedTrips.add(tid);trainRendered=true;trainCount++}}if(trainRendered)return;for(let i=0;i<seq.length-1;i++){const a=seq[i],b=seq[i+1];if(a.departure==null||b.arrival==null)continue;if(currentTime<a.departure||currentTime>b.arrival)continue;const aNameCheck=normalizeName(a.stop_name||'');const bNameCheck=normalizeName(b.stop_name||'');if(aNameCheck===bNameCheck)continue;const opNum=getOperationNumber(tid,fallbackIndex);if(opNum==='37'||opNum==='29'||opNum==='20'){console.log(`[DEBUG] 運用${opNum}番 時刻${secToHHMMSS(currentTime)}`);console.log('  前駅:',a.stop_name,'発',secToHHMMSS(a.departure));console.log('  次駅:',b.stop_name,'着',secToHHMMSS(b.arrival));console.log('  trip_id:',tid);console.log('  正規化前駅:',a.stop_name,'→',normalizeName(a.stop_name));console.log('  正規化次駅:',b.stop_name,'→',normalizeName(b.stop_name))}const aName=normalizeName(a.stop_name||'');const bName=normalizeName(b.stop_name||'');let rowIndex=-1,idxA=-1,idxB=-1,rowA=-1,rowB=-1;if(route==='SN'){const snRows=window.innerWidth<=768?2:1;for(let r=ROWS-snRows;r<ROWS;r++){if(r<0)continue;const stations=ROWS_STATIONS[r];for(let si=0;si<stations.length;si++){const sNorm=normalizeName(stations[si]);if(sNorm===aName&&rowA<0){rowA=r;idxA=si}if(sNorm===bName&&rowB<0){rowB=r;idxB=si}}}}else{for(let r=0;r<ROWS;r++){const stations=ROWS_STATIONS[r];for(let si=0;si<stations.length;si++){const sNorm=normalizeName(stations[si]);if(sNorm===aName&&rowA<0){rowA=r;idxA=si}if(sNorm===bName&&rowB<0){rowB=r;idxB=si}}}}if(rowA>=0&&rowB>=0){if(rowA===rowB){rowIndex=rowA}else{rowIndex=rowA;if(rowB===rowA+1){idxB=ROWS_STATIONS[rowA].length-1}else{idxB=idxA}}}if(rowIndex<0){for(let r=0;r<ROWS;r++){const stations=ROWS_STATIONS[r].map(s=>normalizeName(s));let ai=-1,bi=-1;for(let si=0;si<stations.length;si++){if(stations[si]===aName)ai=si;if(stations[si]===bName)bi=si}if(ai>=0&&bi>=0){rowIndex=r;idxA=ai;idxB=bi;break}}}if(rowIndex<0){rowIndex=(route==='SN')?ROWS-1:0;idxA=ROWS_STATIONS[rowIndex].indexOf(a.stop_name);idxB=ROWS_STATIONS[rowIndex].indexOf(b.stop_name)}if(rowIndex<0)continue;const pos=stationPos[rowIndex];const n=pos.length;const xA=pos[Math.max(0,Math.min(n-1,idxA>=0?idxA:0))];const xB=pos[Math.max(0,Math.min(n-1,idxB>=0?idxB:n-1))];let cx=xA;if(xB!==xA){const ratio=(currentTime-a.departure)/((b.arrival-a.departure)||1);cx=xA+(xB-xA)*ratio}const yCenter=rowY[rowIndex];const topY=yCenter-18,botY=yCenter+18;let cy=(idxB>idxA)?topY:(idxB<idxA?botY:topY);const circle=document.createElementNS(SVG_NS,'circle');circle.setAttribute('cx',cx);circle.setAttribute('cy',cy);circle.setAttribute('r',8);circle.setAttribute('class','train-circle');circle.style.fill=getComputedStyle(document.documentElement).getPropertyValue('--train-color')||'#fff';circle.style.cursor='pointer';circle.addEventListener('mouseenter',()=>showTooltip(tid,a,b,cx,cy));circle.addEventListener('mouseleave',hideTooltip);circle.addEventListener('click',ev=>{ev.stopPropagation();hideTooltip();showTimetable(tid)});g.appendChild(circle);const opNumFinal=getOperationNumber(tid,fallbackIndex++);const destChar=getDestCharByStops(seq,tid);const labelText=opNumFinal+destChar;const label=document.createElementNS(SVG_NS,'text');label.setAttribute('x',cx+(idxB>idxA?14:-14));label.setAttribute('y',cy+5);label.setAttribute('class','trip-label');label.setAttribute('text-anchor',idxB>idxA?'start':'end');label.textContent=labelText;g.appendChild(label);trainRendered=true;renderedTrips.add(tid);trainCount++;label.addEventListener('click',ev=>{ev.stopPropagation();hideTooltip();showTimetable(tid)});label.style.cursor='pointer';break}});Object.keys(waitingTrains).forEach(stationName=>{const trains=waitingTrains[stationName];if(!trains.length)return;let rowIndex=-1,stationIdx=-1;for(let r=0;r<ROWS;r++){const stations=ROWS_STATIONS[r];for(let si=0;si<stations.length;si++){if(normalizeName(stations[si])===stationName){rowIndex=r;stationIdx=si;break}}if(rowIndex>=0)break}if(rowIndex<0)return;const yCenter=rowY[rowIndex];const topY=yCenter-18,botY=yCenter+18;const xPos=stationPos[rowIndex][stationIdx];trains.forEach((train,index)=>{const direction=train.direction;const baseY=(direction==='down')?topY:botY;const offsetY=(direction==='down')?(-30-index*20):(30+index*20);const cy=baseY+offsetY;const circle=document.createElementNS(SVG_NS,'circle');circle.setAttribute('cx',xPos);circle.setAttribute('cy',cy);circle.setAttribute('r',8);circle.setAttribute('class','train-circle');circle.style.fill=getComputedStyle(document.documentElement).getPropertyValue('--train-color')||'#fff';circle.style.cursor='pointer';circle.style.opacity='0.8';circle.addEventListener('mouseenter',()=>showWaitingTooltip(train.tid,stationName,train.nextDeparture,xPos,cy,train.nextTripId));circle.addEventListener('mouseleave',hideTooltip);circle.addEventListener('click',ev=>{ev.stopPropagation();hideTooltip();showTimetable(train.nextTripId||train.tid)});g.appendChild(circle);const opNum=getOperationNumber(train.tid,fallbackIndex++);const destChar=getDestCharByStops(trips[train.tid],train.tid);const labelText=opNum+destChar;const label=document.createElementNS(SVG_NS,'text');label.setAttribute('x',xPos+14);label.setAttribute('y',cy+5);label.setAttribute('class','trip-label');label.setAttribute('text-anchor','start');label.textContent=labelText;label.style.opacity='0.8';g.appendChild(label);label.addEventListener('click',ev=>{ev.stopPropagation();hideTooltip();showTimetable(train.nextTripId||train.tid)});label.style.cursor='pointer'})});const trainCountDiv=document.getElementById('train_count');if(trainCountDiv){trainCountDiv.textContent='運行中: '+trainCount+'両'}}
function showTooltip(tid,a,b,cx,cy){tooltip.style.display='block';const opNum=opMap[tid]||'?';const destChar=getDestCharByStops(trips[tid],tid);tooltip.innerHTML='<div style="font-weight:700">'+opNum+destChar+'</div><div style="margin-top:6px"><b>前:</b> '+(a.stop_name||'-')+' '+(a.departure?secToHHMMSS(a.departure):'')+'</div><div><b>次:</b> '+(b.stop_name||'-')+' '+(b.arrival?secToHHMMSS(b.arrival):'')+'</div><div style="margin-top:6px;font-size:11px;color:var(--muted)">クリックで時刻表表示</div>';const svg=svgWrap.querySelector('svg');const pt=svg.createSVGPoint();pt.x=cx;pt.y=cy;const sp=pt.matrixTransform(svg.getScreenCTM());tooltip.style.left=(sp.x+12)+'px';tooltip.style.top=(sp.y-28)+'px'}
function showWaitingTooltip(tid,stationName,nextDeparture,cx,cy,nextTripId){tooltip.style.display='block';const opNum=opMap[tid]||'?';const destChar=getDestCharByStops(trips[tid],tid);const nextDep=nextDeparture?secToHHMMSS(nextDeparture):'不明';let nextDestChar='?';if(nextTripId&&trips[nextTripId])nextDestChar=getDestCharByStops(trips[nextTripId],nextTripId);tooltip.innerHTML='<div style="font-weight:700">'+opNum+destChar+' → '+opNum+nextDestChar+'</div><div style="margin-top:6px"><b>状態:</b> '+stationName+'で待機中</div><div><b>次発:</b> '+nextDep+'</div><div style="margin-top:6px;font-size:11px;color:var(--muted)">クリックで次の運用の時刻表表示</div>';const svg=svgWrap.querySelector('svg');const pt=svg.createSVGPoint();pt.x=cx;pt.y=cy;const sp=pt.matrixTransform(svg.getScreenCTM());tooltip.style.left=(sp.x+12)+'px';tooltip.style.top=(sp.y-28)+'px'}
function hideTooltip(){tooltip.style.display='none'}
function showTimetable(tid){const modal=document.getElementById('timetableModal');const title=document.getElementById('timetableTitle');const body=document.getElementById('timetableBody');if(!modal||!title||!body){console.error('Modal not found');return}const arr=trips[tid]||[];const opNum=opMap[tid]||'?';const destChar=getDestCharByStops(arr,tid);const route=tripRoute[tid]||'UNK';const dayType=tripDayType[tid]==='holiday'?'土日祝':'平日';title.textContent=opNum+destChar+' - 時刻表';const destFullName={'伊':'伊野','後':'後免','高':'高知駅前','桟':'桟橋通五丁目','四':'桟橋通四丁目','橋':'はりまや橋','朝':'朝倉','鏡':'鏡川橋','枡':'枡形','知':'知寄町','文':'文珠通','介':'介良通','領':'領石通'}[destChar]||destChar;let html='<div class="timetable-info"><strong>便名:</strong> '+tid+'<br><strong>運用番号:</strong> '+opNum+'仕業<br><strong>行先:</strong> '+destFullName+'<br><strong>路線:</strong> '+(route==='EW'?'東西線':route==='SN'?'南北線':'不明')+'<br><strong>運用日:</strong> '+dayType+'</div><table class="timetable-table"><thead><tr><th>順序</th><th>駅名</th><th>到着</th><th>発車</th></tr></thead><tbody>';arr.forEach(stop=>{const displayName=displayStationName(stop.stop_name||'-');const arrival=stop.arrival!=null?secToHHMMSS(stop.arrival):'-';const departure=stop.departure!=null?secToHHMMSS(stop.departure):'-';html+='<tr><td>'+stop.seq+'</td><td>'+displayName+'</td><td>'+arrival+'</td><td>'+departure+'</td></tr>'});html+='</tbody></table>';body.innerHTML=html;modal.style.display='flex';console.log('Showing timetable for',tid)}
function closeTimetable(){const modal=document.getElementById('timetableModal');if(modal)modal.style.display='none'}
window.addEventListener('click',e=>{const modal=document.getElementById('timetableModal');if(e.target===modal)closeTimetable()});
function setupControls(){const nowBtn=document.getElementById('nowBtn');if(nowBtn)nowBtn.addEventListener('click',()=>{currentTime=nowSeconds();updateTimeUI();renderTrains()});document.querySelectorAll('.jump').forEach(btn=>btn.addEventListener('click',e=>{currentTime+=parseInt(e.currentTarget.dataset.s,10);updateTimeUI();renderTrains()}));const firstBtn=document.getElementById('firstBtn');if(firstBtn)firstBtn.addEventListener('click',()=>{const t=getFirstDeparture();if(t){currentTime=t;updateTimeUI();renderTrains()}});const playBtn=document.getElementById('playBtn');if(playBtn)playBtn.addEventListener('click',e=>{const btn=e.currentTarget;if(anim==null){btn.textContent='停止 ■';playRate=parseFloat(document.getElementById('speed').value)||1;lastTs=null;anim=requestAnimationFrame(loop)}else{btn.textContent='再生 ▶';cancelAnimationFrame(anim);anim=null}});const dayTypeSelect=document.getElementById('dayType');if(dayTypeSelect){dayTypeSelect.addEventListener('change',e=>{currentDayType=e.target.value;renderTrains()})}setInterval(()=>{if(anim==null)updateTimeUI()},250)}
function loop(ts){if(!lastTs)lastTs=ts;const dt=(ts-lastTs)/1000;lastTs=ts;currentTime+=dt*playRate;updateTimeUI();renderTrains();anim=requestAnimationFrame(loop)}
function updateTimeUI(){const el=document.getElementById('bigTime');if(el)el.value=secToHHMMSS(Math.floor(currentTime))}
function getFirstDeparture(){let minT=Infinity;Object.values(trips).forEach(arr=>{if(arr.length>0){const t=(arr[0].departure!=null)?arr[0].departure:(arr[0].arrival!=null?arr[0].arrival:Infinity);if(t<minT)minT=t}});return isFinite(minT)?minT:null}
function hhmmssToSec(s){if(!s)return null;const p=s.split(':').map(x=>parseInt(x,10));if(p.length===2)return p[0]*3600+p[1]*60;if(p.length===3)return p[0]*3600+p[1]*60+p[2];return null}
function secToHHMMSS(t){t=Math.floor(((t%86400)+86400)%86400);const h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=t%60;return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')}
async function init(){try{svgWrap=document.getElementById('svgwrap');tooltip=document.getElementById('tooltip');if(!svgWrap)throw new Error('svgwrap not found');window.opDebug={};await loadUnyoIfExists();await loadData();console.log('=== 運用番号チェック ===');Object.keys(window.opDebug).forEach(opNum=>{const tids=window.opDebug[opNum];if(tids.length>1){console.warn(`運用${opNum}番が複数のtrip_idに割り当てられています:`,tids);tids.forEach(tid=>{const seq=trips[tid];if(seq&&seq.length>0){console.log(`  ${tid}: ${seq[0].stop_name} ${secToHHMMSS(seq[0].departure||0)} → ${seq[seq.length-1].stop_name} ${secToHHMMSS(seq[seq.length-1].arrival||0)}`)}})}});buildSVG();updateTimeUI();renderTrains();setupControls();window.addEventListener('resize',()=>{ROWS_STATIONS=buildROWS_STATIONS();buildSVG();renderTrains()})}catch(err){alert('データ読み込みエラー: '+(err&&err.message?err.message:err));console.error(err)}}
document.addEventListener('DOMContentLoaded',init);
